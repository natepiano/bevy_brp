use async_trait::async_trait;
use rmcp::Error as McpError;
use rmcp::model::CallToolResult;

use crate::brp_tools::request_handler::handle_brp_method_tool_call;
use crate::service::{BrpContext, HandlerContext};
use crate::tool::ToolHandler;

pub struct BrpToolHandler {
    context: HandlerContext<BrpContext>,
}

impl BrpToolHandler {
    pub const fn new(context: HandlerContext<BrpContext>) -> Self {
        Self { context }
    }
}

#[async_trait]
impl ToolHandler for BrpToolHandler {
    async fn call_tool(self: Box<Self>) -> Result<CallToolResult, McpError> {
        brp_method_tool_call(self.context).await
    }
}

/// Generate a BRP handler
pub async fn brp_method_tool_call(
    handler_context: HandlerContext<BrpContext>,
) -> Result<CallToolResult, McpError> {
    let tool_def = handler_context.tool_def()?;

    // Build the formatter factory from the response specification
    let formatter_factory = tool_def.formatter().build_formatter_factory();

    handle_brp_method_tool_call(handler_context.clone(), &formatter_factory).await
}
